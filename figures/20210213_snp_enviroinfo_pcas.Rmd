---
title: "20210213_snp_enviroinfo_pcas"
author: "Hannah Reich"
date: "2/13/2021"
output: html_document
---

```{r}

rm(list=ls())

# Feb 13, 2021
# Reviewer 3 asked if adding in environmental information (substrate near samples, % acropora in transect, depth)
# Running PCAs


library(dplyr)
library(tidyverse)
library(cowplot)
library(pcadapt)
library(vcfR)

path <- "~/Desktop/PhD/Symbiodinium fitti/contam_rm_080819/hq_nocontam_rename_aug19.vcf"
vcf <- read.pcadapt(path, type = "vcf", type.out = "matrix", ploidy = 1)

# updated poptab with enviro info from sheila
poptab2 <- read.csv("~/Desktop/PhD/Symbiodinium fitti/contam_rm_080819/2021_mec_R1/2021_poptab_noBP_enviro_info.csv", header = T)

# add in pop (this has hostXloc so eventually you can split them up)
poptab <- read.csv("~/Desktop/PhD/Symbiodinium fitti/contam_rm_080819/poptab_noBPenviro2.csv", header = T)

# make a subsetted vcf (removes NAs)
sub <- vcf[,c(1:8,14:25,31:33,35:37)]
sub1 <- read.pcadapt(sub)
# run pcadapt
acp <- pcadapt(input = vcf, K = 5)
acp2 <- pcadapt(input = sub1, K = 5)

summary(acp)
pca <- plot(acp, option = "scores", gg.col=transp(cols, 1.0))
pca2 <- plot(acp2, option = "scores", gg.col=transp(cols, 1.0))


# spit out % variance
acp$singular.values
acp2$singular.values


# wrangle into a new dataframe
df1 <- data.frame(Species = poptab[,1], Loc = poptab[,2], ID = poptab[,3], pca = pca$data, Sample_Type = poptab[,5], Depth = poptab[,6], Detail_Benthic = poptab[,7], Benthic_Abbrev = poptab[,8], Apalm_Abundance = poptab[,9], Hybrid_Abudance = poptab[,10], Acerv_Abundance = poptab[,11])

df2 <- data.frame(Species = poptab[,1], Loc = poptab[,2], ID = poptab[,3], pca = pca$data, Sample_Type = poptab[,5], Depth = poptab[,6], Detail_Benthic = poptab[,7], Benthic_Abbrev = poptab[,8], Apalm_Abundance = poptab[,9], Hybrid_Abudance = poptab[,10], Acerv_Abundance = poptab[,11])


#df2 <- data.frame(Species = poptab2[,1], Loc = poptab2[,2], ID = poptab2[,3], pca = pca$data)

all_pca <- as.data.frame(df1)

all_pca2 <- as.data.frame(df2)


cols <- c("C" = "#000000", "H" = "#999999", "P" = "#0072B2")
# back up shapes: 0,1,2,3,8

f <- ggplot(all_pca) + 
  geom_point(aes(all_pca$pca.PC_i, all_pca$pca.PC_j,
               color = all_pca$Species, 
               shape = all_pca$Sample_Type), 
               size = 5, 
               alpha = 0.5) +
  theme_bw() +
  theme(legend.position = "right",
        axis.title = element_text(face = "bold", size = 14),
        plot.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid = element_blank()) +
  scale_color_manual(values = cols, 
                     breaks = c("C", "H", "P"),
                     labels = c("Acropora cervicornis", "Acropora prolifera", "Acropora palmata"),
                     name = "S. fitti host") +
 #   scale_shape_manual(values = c(15,16,17,18,4), breaks = c("BA", "BE", "CU", "FL", "VI"), labels = c("Bahamas", "Belize", "Curacao", "Florida", "USVI"), name = "Location") +
  labs(title = "Nursery Vs Adult coral", x="PC1 (% variance)", y="PC2 (% variance)")
f

#all_pca$Depth <- as.factor(all_pca$Depth)
#all_pca$Depth <- factor(all_pca$Depth, levels = c("1", "2", "3", "4", "5", "6", "7", "11", "13", "17", "23", "25", "27"))

all_pca$Benthic_Abbrev <- as.factor(all_pca$Benthic_Abbrev)
dat_na <- na.omit(all_pca)

### depth abbrev - all data points
depthfig <- ggplot(all_pca2) + 
  geom_point(aes(all_pca2$pca.PC_i, all_pca2$pca.PC_j,
               color = all_pca2$Depth,
               size = all_pca2$Depth,
               shape = all_pca2$Species), 
               alpha = 0.9) +
  theme_bw() +
  theme(legend.position = "right",
        axis.title = element_text(face = "bold", size = 14),
        plot.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid = element_blank()) +
   scale_color_gradient(low = "yellow", high = "navy") +
  labs(title = "PCA by depth - all samples", x="PC1 (52.7% variance)", y="PC2 (30.4% variance)")
depthfig

### depth - na.omit
depth_na <- ggplot(dat_na) + 
  geom_point(aes(dat_na$pca.PC_i, dat_na$pca.PC_j,
               color = dat_na$Depth,
               size = dat_na$Depth,
               shape = dat_na$Species), 
               alpha = 0.9) +
  theme_bw() +
  theme(legend.position = "right",
        axis.title = element_text(face = "bold", size = 14),
        plot.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid = element_blank()) +
  scale_color_gradient(low = "light green", high = "navy") +
  labs(title = "PCA by depth - na.rm",x="PC1 (16.0% variance)", y="PC2 (13.6% variance)")
depth_na
save_plot("~/Desktop/PhD/chapters/chapter 3 - fitti/Figx_pca_DEPTH.pdf", depth_na, base_aspect_ratio = 1.6)

### benthic type - all data points
btfig <- ggplot(all_pca) + 
  geom_point(aes(all_pca$pca.PC_i, all_pca$pca.PC_j,
               color = all_pca$Species, 
               shape = all_pca$Benthic_Abbrev), 
               alpha = 0.5, size = 2.5) +
  theme_bw() +
  theme(legend.position = "right",
        axis.title = element_text(face = "bold", size = 14),
        plot.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid = element_blank()) +
  scale_shape_manual(values = c(3,2,6,1,4,8,9,5,0,7,22)) +
#  scale_color_gradient(low = "red", high = "blue") +
  labs(title = "PCA by benthic abbrev - all samples", x="PC1 (16.0% variance)", y="PC2 (13.6% variance)")
btfig

### benthic type - na.omit
bt_na <- ggplot(dat_na) + 
  geom_point(aes(dat_na$pca.PC_i, dat_na$pca.PC_j, 
               size = dat_na$Benthic_Abbrev,
               color = dat_na$Species), 
               alpha = 0.9, shape = dat_na$Loc) +
  theme_bw() +
  theme(legend.position = "right",
        axis.title = element_text(face = "bold", size = 14),
        plot.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid = element_blank()) +
  scale_shape_manual(values = c(3,2,6,1,4,8,9,5,0,7,22)) +
 # scale_color_gradient2(low = "orange", mid = "red", high = "blue") +
  labs(title = "benthic type - na.rm", x="PC1 (% variance)", y="PC2 (% variance)")
bt_na

### Pct Apalm - all data points
pct_apalm <- ggplot(all_pca) + 
  geom_point(aes(all_pca$pca.PC_i, all_pca$pca.PC_j,
               color = all_pca$Apalm_Abundance, 
               shape = all_pca$Loc,
               size = all_pca$Apalm_Abundance), 
               alpha = 0.9) +
  theme_bw() +
  theme(legend.position = "right",
        axis.title = element_text(face = "bold", size = 14),
        plot.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid = element_blank()) +
   scale_color_gradient(low = "light green", high = "navy") +
  labs(title = "Percent A. palmata abundance", x="PC1 (52.7% variance)", y="PC2 (30.4% variance)")
pct_apalm

save_plot("pct_apalm.pdf", pct_apalm, base_aspect_ratio = 1.6)

### depth - na.omit
pct_apalm_na <- ggplot(dat_na) + 
  geom_point(aes(dat_na$pca.PC_i, dat_na$pca.PC_j,
               color = dat_na$Apalm_Abundance, 
               shape = dat_na$Species), 
               alpha = 0.9, size = 2.5) +
  theme_bw() +
  theme(legend.position = "right",
        axis.title = element_text(face = "bold", size = 14),
        plot.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid = element_blank()) +
  scale_colour_gradient2(low = "yellow", mid = "red", high = "blue") +
  labs(title = "Apalm abundance - na.rm", x="PC1 (% variance)", y="PC2 (% variance)")
pct_apalm_na

### Pct Acerv - all data points
pct_acerv <- ggplot(all_pca) + 
  geom_point(aes(all_pca$pca.PC_i, all_pca$pca.PC_j,
               color = all_pca$Acerv_Abundance, 
               shape = all_pca$Species,
               size = all_pca$Acerv_Abundance), 
               alpha = 0.9) +
  theme_bw() +
  theme(legend.position = "right",
        axis.title = element_text(face = "bold", size = 14),
        plot.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid = element_blank()) +
   scale_color_gradient(low = "light green", high = "navy") +
  labs(title = "Percent A. cervicornis abundance", x="PC1 (52.7% variance)", y="PC2 (30.4% variance)")
pct_acerv

save_plot("pct_acerv.pdf", pct_acerv, base_aspect_ratio = 1.6)

### acerv abundance - na.omit
pct_acerv_na <- ggplot(dat_na) + 
  geom_point(aes(dat_na$pca.PC_i, dat_na$pca.PC_j,
               shape = dat_na$Loc, 
               fill = dat_na$Species,
               size = dat_na$Hybrid_Abudance), 
               alpha = 0.9) +
  theme_bw() +
  theme(legend.position = "right",
        axis.title = element_text(face = "bold", size = 14),
        plot.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid = element_blank()) +
  scale_colour_gradient2(low = "yellow", mid = "red", high = "blue") +
  labs(title = "Acerv abundance - na.rm", x="PC1 (% variance)", y="PC2 (% variance)")
pct_acerv_na

### Pct hybrid - all data points
pct_hy <- ggplot(all_pca) + 
  geom_point(aes(all_pca$pca.PC_i, all_pca$pca.PC_j,
               color = all_pca$Species, 
               shape = all_pca$Loc,
               size = all_pca$Hybrid_Abudance), 
               alpha = 0.9) +
  theme_bw() +
  theme(legend.position = "right",
        axis.title = element_text(face = "bold", size = 14),
        plot.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid = element_blank()) +
   scale_color_gradient(low = "light green", high = "navy") +
  labs(title = "Percent Hybrid abundance", x="PC1 (52.7% variance)", y="PC2 (30.4% variance)")
pct_hy

save_plot("pct_hybrid.pdf", pct_hy, base_aspect_ratio = 1.6)

### depth - na.omit
dat_na$Loc <- as.factor(dat_na$Loc)

pct_hy_na <- ggplot(dat_na) + 
  geom_point(aes(dat_na$pca.PC_i, dat_na$pca.PC_j,
               shape = dat_na$Loc, 
               fill = dat_na$Species,
               size = dat_na$Hybrid_Abudance), 
               alpha = 0.9) +
  theme_bw() +
  theme(legend.position = "right",
        axis.title = element_text(face = "bold", size = 14),
        plot.title = element_text(face = "bold"),
        legend.title = element_text(face = "bold"),
        panel.grid = element_blank()) +
  scale_colour_gradient2(low = "yellow", mid = "red", high = "blue") +
  labs(title = "Hybrid abundance - na.rm", x="PC1 (% variance)", y="PC2 (% variance)")
pct_hy_na

```

